(()=>{"use strict";class t{testCollision(t,i,s){return null}}const i=(t,i,s)=>Math.min(Math.max(t,i),s);class s extends t{constructor(t,i){super(),this.width=t,this.height=i}testCollision(t,i,h){return t instanceof s?this._rectVsRect(this,i,t,h):t instanceof e?this._rectVsCircle(this,i,t,h):void 0}_rectVsRect(t,i,s,e){const h=.5*(this.width+s.width),n=.5*(this.height+s.height),r=i.x-e.x,o=i.y-e.y,a=h-Math.abs(r),d=n-Math.abs(o);if(a>0&&d>0){let t,i=0;return a<d?(i=a,t={x:r<0?1:-1,y:0}):(i=d,t={x:0,y:o<0?1:-1}),{collided:!0,normal:t,depth:i}}return null}_rectVsCircle(t,s,e,h){const n=s.x-t.width/2,r=s.x+t.width/2,o=s.y-t.height/2,a=s.y+t.height/2,d=i(h.x,n,r),c=i(h.y,o,a),l=h.x-d,u=h.y-c,y=Math.hypot(l,u);if(y<e.radius){let t,i;if(0===y){const s=h.x-n,d=r-h.x,c=h.y-o,l=a-h.y,u=Math.min(s,d,c,l);switch(u){case s:t={x:-1,y:0};break;case d:t={x:1,y:0};break;case c:t={x:0,y:-1};break;case l:t={x:0,y:1}}i=e.radius+u}else t={x:l/y,y:u/y},i=e.radius-y;return{collided:!0,normal:t,depth:i}}return null}}class e extends t{constructor(t){super(),this.radius=t}testCollision(t,i,h){if(t instanceof e){const s=h.x-i.x,e=h.y-i.y,n=Math.hypot(s,e),r=this.radius+t.radius;if(n<r){let t;return t=0===n?{x:1,y:0}:{x:s/n,y:e/n},{collided:!0,normal:t,depth:r-n}}}else if(t instanceof s){const s=t.testCollision(this,h,i);if(s)return s.normal.x*=-1,s.normal.y*=-1,s}return null}}class h{constructor(t=0,i=0){this.x=t,this.y=i,this.collider=null,this.rigidBody=null}update(t,i,s){}draw(t){}onCollision(t){}}class n{constructor({gameObject:t,mass:s=10,friction:e=.98,isStatic:h=!1,bounciness:n=.5}={}){this.gameObject=t,this.mass=s,this.friction=i(e,0,1),this.isStatic=h,this.bounciness=i(n,0,1),this.vx=0,this.vy=0}update(t){this.isStatic||(this.vx*=this.friction,this.vy*=this.friction,this.gameObject.x+=this.vx*t,this.gameObject.y+=this.vy*t)}}class r{constructor({gravity:t=9.8,tiltDeadzone:i=.05}={}){this.gravity=t,this.tiltDeadzone=i,this.tilt={x:0,y:0},this.raw={x:0,y:0,z:0},this.keys={ArrowUp:!1,ArrowDown:!1,ArrowLeft:!1,ArrowRight:!1}}setup(){addEventListener("keydown",t=>this.keys[t.code]=!0),addEventListener("keyup",t=>this.keys[t.code]=!1),addEventListener("devicemotion",t=>{const i=t.accelerationIncludingGravity;i&&(this.raw.x=i.x,this.raw.y=i.y,this.raw.z=i.z,this.tilt.x=-this.raw.x/this.gravity,this.tilt.y=this.raw.y/this.gravity,Math.abs(this.tilt.x)<this.tiltDeadzone&&(this.tilt.x=0),Math.abs(this.tilt.y)<this.tiltDeadzone&&(this.tilt.y=0))})}simulateTiltWithArrowKeys(t=.5){this.raw.x||(this.tilt.x=(this.keys.ArrowRight-this.keys.ArrowLeft)*t),this.raw.y||(this.tilt.y=(this.keys.ArrowDown-this.keys.ArrowUp)*t)}}class o extends h{constructor(t,i,e,h){super(t,i),this.width=e,this.height=h,this.collider=new s(e,h),this.rigidBody=new n({gameObject:this,isStatic:!0,bounciness:.6})}draw(t){t.fillStyle="#345",t.fillRect(this.x-this.width/2,this.y-this.height/2,this.width,this.height),t.strokeStyle="#557",t.strokeRect(this.x-this.width/2,this.y-this.height/2,this.width,this.height)}}class a extends h{constructor(t,i,e,h,r){super(t,i),this.width=e,this.height=h,this.color=r,this.collider=new s(e,h),this.rigidBody=new n({gameObject:this,mass:15,friction:.95,bounciness:.2})}draw(t){t.fillStyle=this.color,t.fillRect(this.x-this.width/2,this.y-this.height/2,this.width,this.height),t.strokeStyle="#557",t.strokeRect(this.x-this.width/2,this.y-this.height/2,this.width,this.height)}}class d extends h{constructor(t,i,s,h,r=.7){super(t,i),this.radius=s,this.color=h,this.collider=new e(s),this.rigidBody=new n({gameObject:this,mass:.5*s,friction:.99,bounciness:r})}draw(t){t.fillStyle=this.color,t.beginPath(),t.arc(this.x,this.y,this.radius,0,2*Math.PI),t.fill(),t.strokeStyle="#557",t.lineWidth=2,t.stroke()}}class c extends h{constructor(t,i){super(t,i),this.radius=25,this.collider=new e(this.radius),this.rigidBody=new n({gameObject:this,mass:30,friction:.98,bounciness:1}),this.speed=3e3}update(t,i,s){this.rigidBody.vx+=i.tilt.x*this.speed*t,this.rigidBody.vy+=i.tilt.y*this.speed*t}draw(t){t.fillStyle="#f46",t.beginPath(),t.arc(this.x,this.y,this.radius,0,2*Math.PI),t.fill(),t.strokeStyle="#d03",t.lineWidth=2,t.stroke()}}const l=new class{constructor(t,{onUpdate:i,onDraw:s,autoResize:e=!0,doubleBuffering:h=!1}={}){this.canvas=t,this.ctx=this.canvas.getContext("2d"),this.doubleBuffering=h,this.onUpdate=i,this.onDraw=s,this.gameObjects=[],this.isRunning=!1,this.lastTime=0,this.width=0,this.height=0,this.doubleBuffering&&(this.bufferCanvas=document.createElement("canvas"),this.bufferCtx=this.bufferCanvas.getContext("2d")),this.input=new r,this.input.setup(),e&&(window.addEventListener("resize",()=>this.resize()),this.resize())}addGameObject(t){this.gameObjects.push(t)}removeGameObject(t){this.gameObjects=this.gameObjects.filter(i=>i!==t)}clearGameObjects(){this.gameObjects=[]}resize(){this.width=window.innerWidth,this.height=window.innerHeight,this.canvas.width=this.width,this.canvas.height=this.height,this.doubleBuffering&&(this.bufferCanvas.width=this.width,this.bufferCanvas.height=this.height),0!==this.width&&0!==this.height&&(this.isRunning||this._renderFrame())}_renderFrame(){const t=this.doubleBuffering?this.bufferCtx:this.ctx,i={width:this.width,height:this.height};t.clearRect(0,0,this.width,this.height),this.onDraw&&this.onDraw(t,i),this.gameObjects.forEach(i=>i.draw(t)),this.doubleBuffering&&(this.ctx.clearRect(0,0,this.width,this.height),this.ctx.drawImage(this.bufferCanvas,0,0))}_loop(t){if(!this.isRunning)return;if(0===this.width||0===this.height)return void requestAnimationFrame(t=>this._loop(t));const i=(t-this.lastTime)/1e3;this.lastTime=t,this.input.simulateTiltWithArrowKeys();const s={width:this.width,height:this.height};this.onUpdate&&this.onUpdate(i,this.input,s),this.gameObjects.forEach(t=>t.update(i,this.input,s)),this.gameObjects.forEach(t=>t.rigidBody?.update(i));for(let t=0;t<4;++t)this._checkCollisions();this._renderFrame(),requestAnimationFrame(t=>this._loop(t))}_checkCollisions(){const i=this.gameObjects.filter(i=>i.collider instanceof t);for(let t=0;t<i.length;t++){const s=i[t];for(let e=t+1;e<i.length;e++){const t=i[e],h=s.collider.testCollision(t.collider,s,t);h?.collided&&(s.onCollision(t),t.onCollision(s),s.rigidBody&&t.rigidBody&&this._resolveCollision(s,t,h))}}}_resolveCollision(t,i,{normal:s,depth:e}){const h=t.rigidBody.isStatic?0:1/t.rigidBody.mass,n=i.rigidBody.isStatic?0:1/i.rigidBody.mass,r=h+n;if(0===r)return;const o=Math.max(e-.01,0)/r*.8,a=s.x*o,d=s.y*o;t.rigidBody.isStatic||(t.x-=a*h,t.y-=d*h),i.rigidBody.isStatic||(i.x+=a*n,i.y+=d*n);const c=i.rigidBody.vx-t.rigidBody.vx,l=i.rigidBody.vy-t.rigidBody.vy,u=c*s.x+l*s.y;if(u>0)return;const y=-(1+Math.max(t.rigidBody.bounciness,i.rigidBody.bounciness))*u/r,g=y*s.x,w=y*s.y;t.rigidBody.isStatic||(t.rigidBody.vx-=g*h,t.rigidBody.vy-=w*h),i.rigidBody.isStatic||(i.rigidBody.vx+=g*n,i.rigidBody.vy+=w*n)}start(){this.isRunning||(this.isRunning=!0,this.lastTime=performance.now(),requestAnimationFrame(t=>this._loop(t)))}stop(){this.isRunning=!1}}(document.getElementById("game-canvas"),{doubleBuffering:!0,onUpdate:(t,i)=>{document.getElementById("dialog").innerHTML=`Tilt: ${i.tilt.x.toFixed(2)}, ${i.tilt.y.toFixed(2)}`}});document.addEventListener("pointerdown",t=>{if(!l.isRunning)return;const i=t.clientX,s=t.clientY;Math.random()>.5?l.addGameObject(new d(i,s,15+20*Math.random(),"#eb1",.6)):l.addGameObject(new a(i,s,40+20*Math.random(),40+20*Math.random(),"#2c6"))}),document.getElementById("start-btn").addEventListener("click",()=>{document.body.requestFullscreen().then(screen.orientation.lock("portrait-primary")).then(()=>{setTimeout(()=>{l.start(),function(){l.clearGameObjects();const t=window.innerWidth,i=window.innerHeight;l.addGameObject(new o(t/2,-20,t,40)),l.addGameObject(new o(t/2,i+20,t,40)),l.addGameObject(new o(-20,i/2,40,i)),l.addGameObject(new o(t+20,i/2,40,i));const s=.7*t,e=.8*i;for(let t=0;t<4;t++)for(let i=0;i<=t;i++){const h=s+52*i-50*t/2,n=e-52*t;l.addGameObject(new a(h,n,50,50,"#48f"))}for(let s=0;s<5;s++){const s=15+20*Math.random();l.addGameObject(new d(.2*t+Math.random()*t*.2,.2*i+Math.random()*i*.5,s,"#b5f",.8))}l.addGameObject(new o(t/2,i/2,100,50)),l.addGameObject(new c(.2*t,.2*i))}()},100)}).catch(t=>alert(t))})})();